节区感染

将正常的exe文件，劫持其入口地址，使其先运行病毒代码，然后才运行正常的运行代码。由于要过杀毒软件的检测，因此病毒代码通常会写的特别的精简，然后加密自己的代码。

两个exe是同一个文件，其中2.exe即较大的文件是被感染过的exe文件，可以看到其一个特征就是比源文件要大几KB字节。

![image-20250727195029759](./%E7%97%85%E6%AF%92%E6%A1%88%E4%BE%8B.assets/image-20250727195029759.png)

打开小辣椒，可以看到被感染了的文件给自己添加了一个节。

![image-20250727194557944](./%E7%97%85%E6%AF%92%E6%A1%88%E4%BE%8B.assets/image-20250727194557944.png)

对于这种节是可以静态分析的，因为其比较小，通常不会给自己加壳，如果加壳了就会变大容易被检测。通常来说比较小的病毒都是一个下载器，从网络上下载病毒到本地。

由于其是shellcode的形式，对于字符串是没有加密的，通过ida就可以解析它

![image-20250727195506737](./%E7%97%85%E6%AF%92%E6%A1%88%E4%BE%8B.assets/image-20250727195506737.png)

可以看到，这儿节先是获取了模块的Handle，要写的文件路径，要用到的函数地址，创建文件等等，通过`WinExec`函数执行一个cmd指令。

![image-20250727195556416](./%E7%97%85%E6%AF%92%E6%A1%88%E4%BE%8B.assets/image-20250727195556416.png)

往下可以看到，它一直在检测一个入口的地址。记住这个地址`905A4D`。

![image-20250727195800846](./%E7%97%85%E6%AF%92%E6%A1%88%E4%BE%8B.assets/image-20250727195800846.png)

可以看到它写了一个文件，该文件的名称是一个Gpmff.exe。并且是往系统的temp文件里面写入文件

往下大概率是一个加密的代码，我们通过查看字节，来搜索这块地址。找到这块地址

![image-20250727200006807](./%E7%97%85%E6%AF%92%E6%A1%88%E4%BE%8B.assets/image-20250727200006807.png)

往下就是它要写入的一段加密代码。在%temp%里面找到这个文件，发现它加了一个壳。

![image-20250727200236195](./%E7%97%85%E6%AF%92%E6%A1%88%E4%BE%8B.assets/image-20250727200236195.png)

由于它加了壳，那么通过静态的分析就已经不可以了，只能通过OD进行动态运行分析，在运行的时候有一个pushad指令，其下面大多是在运行一个解密代码

![image-20250727200409060](./%E7%97%85%E6%AF%92%E6%A1%88%E4%BE%8B.assets/image-20250727200409060.png)

一直往下运行，遇到循环或者跳转我们就点击某一汇编语句然后按F4，就可以跳转过去了，找到popad以后，大概率表明是姐妹完成，接下来就是跳转到病毒的入口地址了。

![image-20250727200509070](./%E7%97%85%E6%AF%92%E6%A1%88%E4%BE%8B.assets/image-20250727200509070.png)

可以看到这里，它有一个调用后面是OD分析出来的地址，我们ctrl+G，跟进这段地址

![image-20250727200852006](./%E7%97%85%E6%AF%92%E6%A1%88%E4%BE%8B.assets/image-20250727200852006.png)

跳转过来以后，由于OD在我们运行之前就先分析了一次该代码，当时的代码是一个加密状态，所以我们访问的是一个初始状态的缓存。我们通过该exe的解密后跳转到这里，此时代码已经可以解析，删除分析后OD会自动重新解析。

![image-20250727200944807](./%E7%97%85%E6%AF%92%E6%A1%88%E4%BE%8B.assets/image-20250727200944807.png)

往下看就可以看到，其大致的逻辑是，拼接了一段网址，从该网址下载文件以后，通过拼接了我们本地的文件路径，往该文件路径里面按照系统的时间戳生成了一个.exe文件。

![image-20250727201228908](./%E7%97%85%E6%AF%92%E6%A1%88%E4%BE%8B.assets/image-20250727201228908.png)

![image-20250727201628311](./%E7%97%85%E6%AF%92%E6%A1%88%E4%BE%8B.assets/image-20250727201628311.png)

拼接网址后可以得到一个完整的文件。

我们可以在temp文件里面找到它下载的病毒，观察到，该文件有一个自删除的一个指令。其余下载的.exe文件就是下载过来的木马病毒。

![image-20250727201534125](./%E7%97%85%E6%AF%92%E6%A1%88%E4%BE%8B.assets/image-20250727201534125.png)





